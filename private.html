<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Chat</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #ece5dd;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #128c7e;
      color: #fff;
    }
    #backBtn, #backListBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    #friendName {
      flex: 1;
      font-weight: 600;
      font-size: 16px;
    }
    #searchBar {
      margin: 8px;
      padding: 8px 12px;
      border-radius: 20px;
      border: none;
      outline: none;
      width: calc(100% - 16px);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }

    #chatList {
      flex: 1;
      overflow-y: auto;
      background: #fff;
    }
    .chat-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .chat-item:hover {
      background: #f5f5f5;
    }
    .chat-info {
      flex: 1;
    }
    .chat-name {
      font-weight: 600;
    }
    .chat-last {
      font-size: 13px;
      opacity: 0.7;
    }
    .chat-time {
      font-size: 12px;
      opacity: 0.6;
      margin-left: 6px;
    }
    .unread {
      background: #25d366;
      color: #fff;
      border-radius: 10px;
      font-size: 12px;
      padding: 2px 6px;
      margin-left: 8px;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: none;
      flex-direction: column;
    }
    .bubble {
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
      position: relative;
      box-shadow: 0 1px 1px rgba(0,0,0,0.2);
    }
    .mine {
      background: #dcf8c6;
      align-self: flex-end;
    }
    .theirs {
      background: #fff;
      align-self: flex-start;
    }
    .time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
    }
    .tick {
      font-size: 13px;
    }
    .seen {
      color: #34b7f1;
    }

    .input-box {
      display: none;
      padding: 8px 12px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
    }
    .input-box input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      border-radius: 20px;
    }
    .input-box button {
      margin-left: 10px;
      background: #128c7e;
      color: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-size: 18px;
    }
    .input-box button:hover {
      background: #0d7568;
    }
  </style>
</head>
<body>
  <header>
    <button id="backBtn">←</button>
    <div id="friendName">Chats</div>
    <button id="backListBtn" style="display:none;">←</button>
  </header>

  <input id="searchBar" type="text" placeholder="Search or start new chat...">
  <div id="chatList"></div>
  <div id="messages"></div>

  <div class="input-box">
    <input id="msgInput" type="text" placeholder="Type a message...">
    <button id="sendBtn">➤</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, where, orderBy, onSnapshot,
      serverTimestamp, updateDoc, doc, arrayUnion, getDoc, setDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAFKmM22FUSQPYy-eMsBzcZN3bmAxglXl0",
      authDomain: "smart-timetable-266fe.firebaseapp.com",
      projectId: "smart-timetable-266fe"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const me = JSON.parse(localStorage.getItem("chatUser") || "{}");
    if (!me.uid) { document.body.innerHTML = "<p>Please login first.</p>"; throw "no-login"; }

    let currentChatId = null;
    let currentFriend = null;
    let unsubMsg = null;

    const chatListDiv = document.getElementById("chatList");
    const messagesDiv = document.getElementById("messages");
    const inputBox = document.querySelector(".input-box");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const friendNameDiv = document.getElementById("friendName");
    const backBtn = document.getElementById("backBtn");
    const backListBtn = document.getElementById("backListBtn");
    const searchBar = document.getElementById("searchBar");

    backBtn.addEventListener("click", () => window.location.href = "index (13).html");
    backListBtn.addEventListener("click", () => {
      if (unsubMsg) unsubMsg();
      currentChatId = null; currentFriend = null;
      friendNameDiv.textContent = "Chats";
      backListBtn.style.display = "none";
      chatListDiv.style.display = "block";
      messagesDiv.style.display = "none";
      inputBox.style.display = "none";
      searchBar.style.display = "block";
    });

    // Search users
    searchBar.addEventListener("input", async () => {
      const qText = searchBar.value.trim().toLowerCase();
      chatListDiv.innerHTML = "";
      if (!qText) { loadChats(); return; }
      const usersRef = collection(db, "users");
      const usersSnap = await getDocs(usersRef);
      usersSnap.forEach(docSnap => {
        const u = docSnap.data();
        if (u.uid !== me.uid && (u.name || "").toLowerCase().includes(qText)) {
          const div = document.createElement("div");
          div.className = "chat-item";
          div.innerHTML = `<div class='chat-info'><div class='chat-name'>${u.name}</div><div class='chat-last'>Start chat</div></div>`;
          div.addEventListener("click", () => startNewChat(u));
          chatListDiv.appendChild(div);
        }
      });
    });

    // Load chats
    function loadChats() {
      const q = query(collection(db, "privateChats"), where("members", "array-contains", me.uid));
      onSnapshot(q, async snap => {
        chatListDiv.innerHTML = "";
        const chats = [];
        snap.forEach(d => chats.push({ id: d.id, data: d.data() }));
        chats.sort((a, b) => (b.data.lastUpdated?.toMillis?.() || 0) - (a.data.lastUpdated?.toMillis?.() || 0));
        for (const chat of chats) {
          const friendUid = chat.data.members.find(uid => uid !== me.uid);
          const friendDoc = await getDoc(doc(db, "users", friendUid));
          const friendData = friendDoc.data() || { name: "Unknown" };
          const div = document.createElement("div");
          div.className = "chat-item";
          div.innerHTML = `
            <div class="chat-info">
              <div class="chat-name">${friendData.name}</div>
              <div class="chat-last">${chat.data.lastMsg || "No messages yet"}</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="chat-time">${chat.data.lastTime || ""}</span>
            </div>`;
          div.addEventListener("click", () => startChat(chat.id, friendUid, friendData));
          chatListDiv.appendChild(div);
        }
      });
    }
    loadChats();

    async function startNewChat(friend) {
      const chatRef = collection(db, "privateChats");
      const chatsSnap = await getDocs(query(chatRef, where("members", "in", [[me.uid, friend.uid], [friend.uid, me.uid]])));
      let chatId;
      if (!chatsSnap.empty) {
        chatId = chatsSnap.docs[0].id;
      } else {
        const docRef = await addDoc(chatRef, {
          members: [me.uid, friend.uid],
          created: serverTimestamp(),
          lastUpdated: serverTimestamp(),
          lastMsg: ""
        });
        chatId = docRef.id;
      }
      startChat(chatId, friend.uid, friend);
    }

    function startChat(chatId, friendUid, friendData) {
      currentChatId = chatId;
      currentFriend = friendData;
      friendNameDiv.textContent = friendData.name;
      backListBtn.style.display = "inline";
      chatListDiv.style.display = "none";
      messagesDiv.style.display = "flex";
      inputBox.style.display = "flex";
      searchBar.style.display = "none";

      if (unsubMsg) unsubMsg();
      const msgQ = query(collection(db, "privateChats", chatId, "messages"), orderBy("timestamp"));
      unsubMsg = onSnapshot(msgQ, snap => {
        console.log("Loaded messages:", snap.size);
        messagesDiv.innerHTML = "";
        if (snap.empty) {
          messagesDiv.innerHTML = "<p style='text-align:center;color:gray;'>No messages yet</p>";
          return;
        }
        snap.forEach(d => {
          const m = d.data();
          const bubble = document.createElement("div");
          bubble.className = "bubble " + (m.senderUid === me.uid ? "mine" : "theirs");
          const timeStr = m.timestamp?.toDate?.().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || "";
          let tickHtml = "";
          if (m.senderUid === me.uid) {
            const isSeen = currentFriend && m.seenBy?.includes(currentFriend.uid);
            tickHtml = `<span class="tick ${isSeen ? 'seen' : ''}">✔✔</span>`;
          }
          bubble.innerHTML = `<div>${m.text}</div><div class="time"><span>${timeStr}</span>${tickHtml}</div>`;
          messagesDiv.appendChild(bubble);
          if (m.senderUid !== me.uid) markSeen(d.id);
        });
        messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: "smooth" });
      });
    }

    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text || !currentChatId) return;
      console.log("Sending message to chat:", currentChatId);
      const msgRef = collection(db, "privateChats", currentChatId, "messages");
      await addDoc(msgRef, {
        senderUid: me.uid,
        text,
        timestamp: serverTimestamp(),
        seenBy: [me.uid]
      });
      await updateDoc(doc(db, "privateChats", currentChatId), {
        lastMsg: text,
        lastUpdated: serverTimestamp(),
        lastTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      msgInput.value = "";
    }
    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    async function markSeen(docId) {
      const msgRef = doc(db, "privateChats", currentChatId, "messages", docId);
      try {
        await updateDoc(msgRef, { seenBy: arrayUnion(me.uid) });
      } catch (e) {
        console.log("Error marking seen:", e);
      }
    }
  </script>
</body>
</html>
