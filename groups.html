<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-like Chat</title>
<style>
:root {
  --green:#25D366; --dark:#0B141A; --darker:#131C21; --light:#E1E1E1;
  --msg:#DCF8C6; --gray:#8596A0;
  font-family:system-ui,Roboto,Helvetica,Arial,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--dark);color:var(--light);display:flex;justify-content:center;align-items:center;min-height:100vh;}
.app{display:grid;grid-template-columns:300px 1fr;gap:1rem;width:95%;max-width:1200px;height:90vh;}
@media(max-width:800px){.app{grid-template-columns:1fr;height:100vh;}}
.sidebar,.chat{background:var(--darker);border-radius:8px;display:flex;flex-direction:column;overflow:hidden;}
.sidebar header{display:flex;align-items:center;justify-content:flex-end;padding:1rem;background:var(--dark);}
.sidebar .groups{flex:1;overflow:auto;padding:.6rem;display:flex;flex-direction:column;gap:.4rem;}
.group{padding:.6rem;border-radius:6px;background:#1f2c33;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.group:hover{background:#223038;}
.chat header{background:var(--dark);padding:.8rem 1rem;border-bottom:1px solid #1f2c33;display:flex;justify-content:space-between;align-items:center;}
.messages{flex:1;overflow:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem;scroll-behavior:smooth;}
.msg{max-width:70%;padding:.6rem .8rem;border-radius:10px;background:#1f2c33;}
.me{align-self:flex-end;background:var(--msg);color:#000;}
.meta{font-size:.75rem;color:var(--gray);margin-top:2px;display:flex;justify-content:space-between;}
.composer{padding:.6rem 1rem;border-top:1px solid #1f2c33;display:flex;gap:.4rem;}
.composer input{flex:1;padding:.5rem .8rem;border-radius:50px;border:none;outline:none;background:#1f2c33;color:var(--light);}
.composer button{background:var(--green);color:#fff;border:none;border-radius:50px;padding:.5rem 1rem;cursor:pointer;}
.composer button:hover{opacity:.8;}
button.small{background:none;border:none;color:var(--gray);cursor:pointer;font-size:.8rem;}
.filepreview{font-size:.8rem;color:var(--gray);margin:.2rem 1rem;}
.typing{font-size:.8rem;color:var(--gray);padding:.2rem 1rem;}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <header>
      <!-- Removed avatar, username, email -->
      <button id="signin" class="small">Sign in</button>
      <button id="signout" class="small" style="display:none;">Sign out</button>
    </header>
    <div style="padding:.5rem 1rem;">
      <input id="search" placeholder="Search or start new chat" style="width:100%;padding:.4rem;border:none;border-radius:6px;background:#1f2c33;color:var(--light);">
      <button id="createGroup" class="small" style="margin-top:.3rem;">+ Create Group</button>
    </div>
    <div class="groups" id="groups"></div>
  </div>

  <div class="chat">
    <header>
      <div>
        <div id="groupName" style="font-weight:600;">Select a group</div>
        <div id="members" style="font-size:.8rem;color:var(--gray);"></div>
      </div>
      <button id="deleteGroup" class="small" style="display:none;color:#f55;">Delete</button>
    </header>
    <div class="messages" id="messages"></div>
    <div id="typing" class="typing"></div>
    <div id="fileprev" class="filepreview"></div>
    <div class="composer">
      <input id="messageInput" placeholder="Type a message" />
      <input id="file" type="file" style="display:none;" />
      <button id="attach">ðŸ“Ž</button>
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, getDoc, updateDoc, onSnapshot,
  query, orderBy, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import {
  getStorage, ref as sRef, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyAFKmM22FUSQPYy-eMsBzcZN3bmAxglXl0",
  authDomain:"smart-timetable-266fe.firebaseapp.com",
  projectId:"smart-timetable-266fe",
  storageBucket:"smart-timetable-266fe.appspot.com"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app); const auth=getAuth(app); const storage=getStorage(app);

let user=null,activeGroup=null,unsubMsgs=null,unsubTyping=null,fileToSend=null;
const $=(id)=>document.getElementById(id);
const signin=$('signin'),signout=$('signout'),groupsEl=$('groups'),
createGroup=$('createGroup'),search=$('search'),groupName=$('groupName'),
members=$('members'),messagesEl=$('messages'),sendBtn=$('send'),
input=$('messageInput'),attach=$('attach'),file=$('file'),
fileprev=$('fileprev'),typingEl=$('typing'),delGroup=$('deleteGroup');

signin.onclick=async()=>{await signInWithPopup(auth,new GoogleAuthProvider());};
signout.onclick=()=>signOut(auth);
onAuthStateChanged(auth,u=>{
  user=u?{uid:u.uid,name:u.displayName||"User",email:u.email||""}:null;
  if(u){signin.style.display='none';signout.style.display='block';}
  else{signin.style.display='block';signout.style.display='none';}
  renderGroups();
});

createGroup.onclick=async()=>{
  if(!user)return alert('Sign in');
  const name=prompt('Group name?'); if(!name)return;
  await addDoc(collection(db,'groups'),{
    name,creator:user.uid,members:[user.uid],admins:[user.uid],created:serverTimestamp()
  });
};

search.oninput=()=>renderGroups();

function renderGroups(){
  groupsEl.innerHTML='';
  onSnapshot(query(collection(db,'groups'),orderBy('created','desc')),snap=>{
    groupsEl.innerHTML='';
    snap.forEach(d=>{
      const g={id:d.id,...d.data()};
      if(!g.name.toLowerCase().includes(search.value.toLowerCase()))return;
      const row=document.createElement('div');row.className='group';
      row.innerHTML=`<div>${g.name}</div><small>${g.members?.length||0}</small>`;
      row.onclick=()=>openGroup(g);
      groupsEl.appendChild(row);
    });
  });
}

async function openGroup(g){
  if(unsubMsgs)unsubMsgs(); if(unsubTyping)unsubTyping();
  const gdoc=await getDoc(doc(db,'groups',g.id)); if(!gdoc.exists())return;
  activeGroup={id:g.id,...gdoc.data()};
  groupName.textContent=activeGroup.name;
  members.textContent=`${activeGroup.members?.length||0} members`;
  const isAdmin=activeGroup.admins?.includes(user?.uid)||activeGroup.creator===user?.uid;
  delGroup.style.display=isAdmin?'block':'none';
  unsubMsgs=onSnapshot(query(collection(db,'groups',g.id,'messages'),orderBy('timestamp','asc')),snap=>{
    messagesEl.innerHTML='';
    snap.forEach(m=>{
      const msg=m.data();
      const div=document.createElement('div');
      div.className='msg'+(msg.senderUid===user?.uid?' me':'');
      let html=`<div>${msg.text||''}</div>`;
      if(msg.attach){html+=`<a href='${msg.attach}' target='_blank'>ðŸ“Ž file</a
